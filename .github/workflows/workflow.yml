name: Continuous Deployment

on:
  push:
    branches:
      - master

jobs:
  Deployment:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: appsettings.json Variable Substitution
        uses: microsoft/variable-substitution@v1
        with:
          files: Server/appsettings.json
        env:
          ConnectionStrings.DefaultConnection: ${{ secrets.ConnectionString }}

      - name: database.env Variable Substitution
        run: sed -i 's/P4ssW0rd!/${{ secrets.DatabasePassword }}/g' Server/database.env

      - name: End Previous Containers
        run: docker-compose down

      - name: Remove Old Image
        run: docker image rm hopkinstech

      - name: Start Containers
        run: docker-compose up -d
